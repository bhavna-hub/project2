---
title: "Project2_ver1"
author: "Bhavna Murthy"
date: "3/2/2021"
output: html_document
---
## Abstract

## Introduction
Our main question of interest for this exploratory data analysis is whether or not there is a difference in the new case proportion growth rate between April and August amongst countries in the “Americas” region (per WHO classification) that had implemented a mask mandate, testing, and/or lockdown policy by April 1st, 2020 versus those that didn’t implement all or part of these policies by that time. If a difference is apparent, a follow-up question would be whether or not countries with a mask mandate in place had lower proportions of new cases when compared to countries that did not implement all or part of such measures until after April 1st, 2020.

The results of this data analysis could better inform us on the effectiveness of mask and testing policy in stemming the spread of COVID-19. In turn, this information could have significant public policy implications as countries decide whether or not to implement mask mandates and introduce more widespread testing to combat the COVID-19 pandemic. The results of this analysis can be used to build political and public support either for or against these measures based on its results. Additionally, if such policies are shown to be effective in stemming the spread of COVID-19, this analysis would allow researchers to better forecast the impact of COVID-19 on countries based on whether or not they had implemented the mentioned policies by April 1st, 2020.

We will be examining two datasets in this report. One was produced by the World Health Organization (WHO) regarding the COVID-19 pandemic. This dataset features the following variables of interest: number of new COVID cases, deaths attributable to COVID-19, and a cumulative measure of both data points since January 3rd, 2020 until the present. Data has been compiled from all countries that are members of the WHO. The second dataset was published in the journal Nature and includes data from the European Center for Disease Prevention and Control, Oxford, and other sources. This particular dataset examines the response of governments to COVID-19. Some of the key variables from this dataset that will be relied on for this report include: obligation to wear masks (binary value tracking whether or not mask mandate is in place), testing policy (binary value tracking whether or not a public testing policy is in place), number of new cases reported each day for each respective country, etc.

At the onset, we hypothesize that because masks prevent air from flowing between persons, they will be effective in reducing the transmission of COVID-19 amongst a population. Therefore, we expect to see that countries that implemented the mask mandate on or before April 1st, 2020 had a lower new case proportion growth versus countries that did not implement such policies until after the mentioned date. Furthermore, having a public testing policy would allow COVID-19 cases to be caught early on so that people can go into isolation and minimize their likelihood of spreading the virus to other people. Instituting a lockdown would be expected to have a similar impact. So it can also be hypothesized that countries with public testing policies and/or a lockdown in place may have lower new case proportion growth. 

## Background

## Decriptive Analysis
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(dplyr)
library(ggplot2)
library(reshape2)
```


```{r}
covid <- read_csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")

policy <- read_excel("Data/Gov_Responses2Covid19_last.xlsx")
```

```{r}
by_country <- policy %>%
  group_by(country)

policy2 <- by_country %>%
  subset(d=='31aug2020' | d=='01apr2020')

for (x in 1:nrow(policy2)) {
  if (policy2$d[x]=='31aug2020') {
    policy2$d[x]<-'2020-08-31' 
  }
  else {
    policy2$d[x]<-'2020-4-01'
  }
} 

covid2 <- covid %>%
  subset(Date_reported=='2020-08-31' | Date_reported=='2020-04-01') 

policy2$date<-as.Date(policy2$d, "%Y-%m-%d")

policy2<-policy2 %>%
  subset(select=-c(d))

df<-merge(x=policy2, y=covid2, by.x=c("geoid", "date"), by.y=c("Country_code", "Date_reported"))
df<-df %>%
  mutate(case_proportion=(Cumulative_cases/as.numeric(population_2019))) 



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


Adding case mortality column
```{r}
df$Case_mort = df$Cumulative_deaths/df$Cumulative_cases
```

```{r}
glimpse(df)
```

#summary statistics
```{r}
# earliet date
min(covid$Date_reported)
```

```{r}
# Latest date
max(covid$Date_reported)
```

```{r}
# Halfway point
median(covid$Date_reported)
```

```{r}
summary(df$cases)
```

```{r}
summary(df$deaths)
```

```{r}
summary(df$Case_mort)
```


```{r}
df[which.max(df$Case_mort),]
```


```{r}
### CREATE VARIABLE FOR CASE GROWTH RATE BETWEEN APRIL 01 AND AUGUST 31 ###
for (country in 1:nrow(df)) {
  
  df$growth2[country]<-log(df$Cumulative_cases[country+1])-log(df$Cumulative_cases[country])
}

na.index<-is.na(df$growth2)
inf.index<-is.infinite(df$growth2)
nan.index<-is.nan(df$growth2)
df.growthrates<-df[!na.index & !inf.index & !nan.index,]
```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD MASK POLICY IN APRIL VERSUS NO MASK POLICY IN APRIL ###

df.maskapril<-subset(df.growthrates, masks==1 & date=='2020-04-01')

df.augresult<-subset(df.growthrates, df$country %in% df.maskapril$country & date=='2020-04-01')

#mask.result<-summary(df.augresult$case_proportion)


df.nomaskapril<-subset(df.growthrates, masks==0 & date=='2020-04-01')

df.augresult.nm<-subset(df.growthrates, df$country %in% df.nomaskapril$country & date=='2020-04-01')

#nomask.result<-summary(df.augresult.nm$case_proportion)

boxplot(df.augresult$growth2, df.augresult.nm$growth2,
        names=c('Mask policy in April', 'No mask policy in April'),
        ylim=c(0, 10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st mask policy')
```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD TESTING POLICY IN APRIL VERSUS ###
### NO TESTING POLICY IN APRIL ###

df.test.april<-subset(df.growthrates, testing==1 & date=='2020-04-01')

df.augresult.test<-subset(df.growthrates, df$country %in% df.test.april$country & date=='2020-04-01')

#test.result<-summary(df.augresult.test$case_proportion)


df.notest.april<-subset(df.growthrates, testing==0 & date=='2020-04-01')

df.augresult.notest<-subset(df.growthrates, df$country %in% df.notest.april$country & date=='2020-04-01')

#nomass.result<-summary(df.augresult.notest$case_proportion)

boxplot(df.augresult.test$growth2, df.augresult.notest$growth2,
        names=c('Testing Policy in April', 'No Testing Policy in April'),
        ylim=c(0, 10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st testing policy')
```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD LOCKDOWN POLICY IN APRIL VERSUS ###
### NO LOCKDOWN POLICY IN APRIL ###

df.ld.april<-subset(df.growthrates, domestic==1 & date=='2020-04-01')

df.augresult.ld<-subset(df.growthrates, df$country %in% df.ld.april$country & date=='2020-04-01')

#ld.result<-summary(df.augresult.ld$case_proportion)


df.nold.april<-subset(df.growthrates, domestic==0 & date=='2020-04-01')

df.augresult.nold<-subset(df.growthrates, df$country %in% df.nold.april$country & date=='2020-04-01')

#nold.result<-summary(df.augresult.nold$case_proportion)

boxplot(df.augresult.ld$growth2, df.augresult.nold$growth2,
        names=c('Lockdown Policy in April', 'No Lockdown Policy in April'),
        ylim=c(0,10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st lockdown policy')

```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD RESTURANT POLICY IN APRIL VERSUS ###
### NO LOCKDOWN POLICY IN APRIL ###

df.ld.april<-subset(df.growthrates, rest==1 & date=='2020-04-01')

df.augresult.ld<-subset(df.growthrates, df$country %in% df.ld.april$country & date=='2020-04-01')

ld.result<-summary(df.augresult.ld$case_proportion)


df.nold.april<-subset(df.growthrates, rest==0 & date=='2020-04-01')

df.augresult.nold<-subset(df.growthrates, df$country %in% df.nold.april$country & date=='2020-04-01')

nold.result<-summary(df.augresult.nold$case_proportion)

boxplot(df.augresult.ld$growth2, df.augresult.nold$growth2,
        names=c('Restaurant Closures in April', 'No Rest. Closures in April'),
        ylim=c(0,10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st lockdown policy')

```



## Inferential Analysis
Our primary question of interest is whether certain policies enacted at the national and sub-national level may be associated with different outcomes in terms of the cumulative case proportion and growth of cumulative cases a country experiences over a five month period. The policies we have examined include mask wearing obligations, testing implementation, lockdown enforcement, and restaurant closures. These policies were measured according to their implementation on April 1st of 2020. If the policy had been implemented at the national or local level by that date, then the variable takes a variable of one. If the policy had not been implemented, it takes a value of zero. 

A secondary question of interest then entails which of these different policies, if any, are associated with country wide case proportions measured five months later on August 31, as well as the average growth rate of cases during that same five month interval. 

For the purposes of this study, case proportion is defined as $X_i/N_i$, where $X_i$ represents the cumulative cases recorded for the i-th country on August 31 of 2020, and $N_i$ corresponds to that country's population in 2019. 
```{r}
## Created a dataframe with just the country, growth rate in August, whether mask testing, lockdown in April

# Can be used for anova model
#masking_policy_april = subset(df, date =='2020-04-01')
#august_results = subset(df, date == "2020-08-31")
#df1 = data.frame( country =masking_policy_april$country, case_growth = august_results$case.growth, masks =masking_policy_april$masks,
                 #lockdown =masking_policy_april$domestic,
                 #testing =masking_policy_april$testing )
```

```{r}


### Adam model ###



model_case.proportion<-glm(data=df, formula=case_proportion[which(date=='2020-08-31')]~
            masks[which(date=='2020-04-01')]+testing[which(date=='2020-04-01')]+
            domestic[which(date=='2020-04-01')]+rest[which(date=='2020-04-01')])


model_growth.rate<-lm(data=df.growthrates, formula=growth2[which(date=='2020-04-01')]~
            masks[which(date=='2020-04-01')]+testing[which(date=='2020-04-01')]+
            domestic[which(date=='2020-04-01')]+rest[which(date=='2020-04-01')])


summary(model_case.proportion)
summary(model_growth.rate)

```


## Sensitivity Analysis

```{r}
plot(model_case.proportion,which =1)
```

The residuals versus fitted plot shows the spread widening as the predicted values increases. This indicates that that the errors do not have equal variance. If the errors were normally distributed the errors would have be spread evenly and randomly around the 0 line. Observations 20,253 and 165 seems to have a high variance.
```{r}
plot(model_case.proportion,which =2)
```

The normal Q-Q plot shows that the errors have heavy tail on the right. Again observations 20,153,165 are contributing to the problem. The errors are not normally distributed.

```{r}
plot(model_case.proportion,which =3)
```

The scale location plot is also used to check the equal variance assumption. Again it is visible that the spread of variance increases as the predicted value increases. Also as expected observations 20, 153 and 165 are still outliers.
```{r}
plot(model_case.proportion,which =4)
```


The residuals versus Leverage plot shows that the spread of standardized residuals is decreasing indicating that the variances are unequal. There are no observations outside the red lines so that there are no highly influentail data points.

Using an alternative model that looked at case growth rate in August as the response variable the we get the following sensitivity results for the model.
```{r}
# New case growth rate model
plot(model_growth.rate,which =1)
```

The residuals versus fitted plot for case growth rate is evenly and randomly spread spread over the line y=0. The spread does get wider slightly around predicted value 4.0. But the errors do have equal variance. Observations 86 and 139 are high outliers. While 24 is low outlier.

```{r}
plot(model_growth.rate,which =2)
```
    
From the normal Q-Q plot the residuals have lighter tail on both ends. But it looks symmetrically lighter. And they do follow the line mostly. So the errors are normally distributed. The outliers 86,139 and 24 are pulling the distribution away from normal.

```{r}
plot(model_growth.rate,which =3)
```

The scale location plot shows that the red line is almost horizontal. The spread does get larger towards higher fitted values but it centered. We can back up the claim that the errors have equal variance. Observations 139 and 24 are noted as outliers.

```{r}
plot(model_growth.rate,which =4)
```


Cook's distance measures the influence certain observations have on distributions. The higher Cook's distance is the more influential the observation is. Observations 16,86,99 are noted have large Cook's distance.

```{r}
  tmp =df.growthrates$growth2[which(df.growthrates$date=='2020-04-01')]
mean(tmp)
sd(tmp)
tmp[86]
```
So observation 86 had a case growth rate 2 standard deviations above the mean.

