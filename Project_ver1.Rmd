---
title: "STA 141: Analysis of Covid Case Growth Rates Across Different Countries"
author: "Group 12"
date: "3/2/2021"
output: html_document
---
## Abstract

## Introduction
Our main question of interest for this exploratory data analysis is whether or not there is a difference in the new case proportion growth rate between April and August amongst countries in the “Americas” region (per WHO classification) that had implemented a mask mandate, testing, and/or lockdown policy by April 1st, 2020 versus those that didn’t implement all or part of these policies by that time. If a difference is apparent, a follow-up question would be whether or not countries with a mask mandate in place had lower proportions of new cases when compared to countries that did not implement all or part of such measures until after April 1st, 2020.

The results of this data analysis could better inform us on the effectiveness of mask and testing policy in stemming the spread of COVID-19. In turn, this information could have significant public policy implications as countries decide whether or not to implement mask mandates and introduce more widespread testing to combat the COVID-19 pandemic. The results of this analysis can be used to build political and public support either for or against these measures based on its results. Additionally, if such policies are shown to be effective in stemming the spread of COVID-19, this analysis would allow researchers to better forecast the impact of COVID-19 on countries based on whether or not they had implemented the mentioned policies by April 1st, 2020.

We will be examining two datasets in this report. One was produced by the World Health Organization (WHO) regarding the COVID-19 pandemic. This dataset features the following variables of interest: number of new COVID cases, deaths attributable to COVID-19, and a cumulative measure of both data points since January 3rd, 2020 until the present. Data has been compiled from all countries that are members of the WHO. The second dataset was published in the journal Nature and includes data from the European Center for Disease Prevention and Control, Oxford, and other sources. This particular dataset examines the response of governments to COVID-19. Some of the key variables from this dataset that will be relied on for this report include: obligation to wear masks (binary value tracking whether or not mask mandate is in place), testing policy (binary value tracking whether or not a public testing policy is in place), number of new cases reported each day for each respective country, etc.

At the onset, we hypothesize that because masks prevent air from flowing between persons, they will be effective in reducing the transmission of COVID-19 amongst a population. Therefore, we expect to see that countries that implemented the mask mandate on or before April 1st, 2020 had a lower new case proportion growth versus countries that did not implement such policies until after the mentioned date. Furthermore, having a public testing policy would allow COVID-19 cases to be caught early on so that people can go into isolation and minimize their likelihood of spreading the virus to other people. Instituting a lockdown would be expected to have a similar impact. So it can also be hypothesized that countries with public testing policies and/or a lockdown in place may have lower new case proportion growth. 

## Background

As previously mentioned, two datasets were used in the creation of this analysis. The first such dataset was obtained from the WHO and featured variables pertaining to new cases of COVID-19 infections as well as deaths attributable to the virus. As aforementioned, this data had been harvested since January 3rd 2020 up to the present. The WHO went about obtaining the information needed for this dataset by collecting data via official communications, which were conducted per International Health Regulations, and supplemented this with data reported by countries’ governmental health agencies (this includes any information disclosed by these agencies on their websites and social media channels). During this process, the number of new cases and deaths catalogued were only recorded if these cases were laboratory-confirmed and fell within the WHO's definitions for confirmed cases. Specifically, in order to be classified as a new case of COVID-19, a person would have to have a positive Nucleic Acid Amplification Test result and/or be identified as being positive for the SARS-CoV-2 Antigen. Additional data apart from that reported by member countries was obtained from the European Center for Disease Prevention and Control. Possible sources of bias in this dataset may include: bias on the part of health ministries in WHO member countries when reporting their data, lack of accurate reporting from WHO member countries with underdeveloped health systems and lack of significant healthcare infrastructure, bias in the AI web-scraping algorithm used to harvest data from public press releases and social media posts made by governmental health agencies, etc.


The second dataset was obtained from the University of Oxford’s COVID-19 Government response tracker and features several variables documenting the governmental response of countries to the COVID-19 pandemic. In total, 13 public health measures and 7 measures of economic policy were catalogued in this dataset. Each of these measures were assessed with a binary datapoint (1 or 0) depending on whether or not the policy indicated had been implemented by the country in question. In a few cases, a measure of “0.5” was used to denote partial implementation of a particular policy. Those of particular interest for this analysis included: obligation to wear masks in public settings, whether or not a public testing policy was in place, and whether or not a domestic lockdown had been initiated. Data for each of the public health measures catalogued by the dataset were obtained from the Assessment Capacities Project (ACAPs), the International Monetary Fund (IMF), and from information made publicly available by countries’ governmental health agencies. Possible sources of bias in this dataset may include: bias on the part of governmental health agencies when publicly disclosing information about their policy responses to COVID-19, lack of coordinated policy measures implemented by countries with weakly structured governments, etc.

Citation: Hale, Thomas, Noam Angrist, Emily Cameron-Blake, Laura Hallas, Beatriz Kira, Saptarshi Majumdar, Anna Petherick, Toby Phillips, Helen Tatlow, Samuel Webster (2020). Oxford COVID-19 Government Response Tracker, Blavatnik School of Government.


Existing research published in the American Journal of Tropical Medicine and Hygiene as well as by the National Academy of Sciences in the United States has shown that COVID-19 transmission rates are forecasted to be 7.5 times higher in countries without a mask mandate as opposed to countries with one in place. And as expected, countries with a mask mandate have a lower COVID-19 related mortality rate than those that have not implemented such policies. Additionally, it was observed that the duration of time spent in lockdown was inversely correlated with COVID-19 related mortality rate, which is also in line with expectations. On the other hand, increased public testing for COVID-19 was shown to not have a statistically significant relationship with COVID-19 related mortality rate. 
Citation: Leffler, Christoper T, et al. “Association of Country-Wide Coronavirus Mortality with Demographics, Testing, Lockdowns, and Public Wearing of Masks.” The American Journal of Tropical Medicine and Hygiene, vol. 103, no. 6, 13 Aug. 2020, pp. 2400–2411., doi:https://doi.org/10.4269/ajtmh.20-1015. 



## Decriptive Analysis
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(dplyr)
library(ggplot2)
library(reshape2)
```


```{r}
covid <- read_csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")

policy <- read_excel("Data/Gov_Responses2Covid19_last.xlsx")
```

```{r}
by_country <- policy %>%
  group_by(country)

policy2 <- by_country %>%
  subset(d=='31aug2020' | d=='01apr2020')

for (x in 1:nrow(policy2)) {
  if (policy2$d[x]=='31aug2020') {
    policy2$d[x]<-'2020-08-31' 
  }
  else {
    policy2$d[x]<-'2020-4-01'
  }
} 

covid2 <- covid %>%
  subset(Date_reported=='2020-08-31' | Date_reported=='2020-04-01') 

policy2$date<-as.Date(policy2$d, "%Y-%m-%d")

policy2<-policy2 %>%
  subset(select=-c(d))

df<-merge(x=policy2, y=covid2, by.x=c("geoid", "date"), by.y=c("Country_code", "Date_reported"))
df<-df %>%
  mutate(case_proportion=(Cumulative_cases/as.numeric(population_2019))) 



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


Adding case mortality column
```{r}
df$Case_mort = df$Cumulative_deaths/df$Cumulative_cases
```

```{r}
glimpse(df)
```

#summary statistics
```{r}
# earliet date
min(covid$Date_reported)
```

```{r}
# Latest date
max(covid$Date_reported)
```

```{r}
# Halfway point
median(covid$Date_reported)
```

```{r}
summary(df$cases)
```

```{r}
summary(df$deaths)
```

```{r}
summary(df$Case_mort)
```


```{r}
df[which.max(df$Case_mort),]
```


```{r}
### CREATE VARIABLE FOR CASE GROWTH RATE BETWEEN APRIL 01 AND AUGUST 31 ###
for (country in 1:nrow(df)) {
  
  df$growth2[country]<-log(df$Cumulative_cases[country+1])-log(df$Cumulative_cases[country])
}

na.index<-is.na(df$growth2)
inf.index<-is.infinite(df$growth2)
nan.index<-is.nan(df$growth2)
df.growthrates<-df[!na.index & !inf.index & !nan.index,]
```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD MASK POLICY IN APRIL VERSUS NO MASK POLICY IN APRIL ###

df.maskapril<-subset(df.growthrates, masks==1 & date=='2020-04-01')

df.augresult<-subset(df.growthrates, df$country %in% df.maskapril$country & date=='2020-04-01')

#mask.result<-summary(df.augresult$case_proportion)


df.nomaskapril<-subset(df.growthrates, masks==0 & date=='2020-04-01')

df.augresult.nm<-subset(df.growthrates, df$country %in% df.nomaskapril$country & date=='2020-04-01')

#nomask.result<-summary(df.augresult.nm$case_proportion)

boxplot(df.augresult$growth2, df.augresult.nm$growth2,
        names=c('Mask policy in April', 'No mask policy in April'),
        ylim=c(0, 10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st mask policy')
```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD TESTING POLICY IN APRIL VERSUS ###
### NO TESTING POLICY IN APRIL ###

df.test.april<-subset(df.growthrates, testing==1 & date=='2020-04-01')

df.augresult.test<-subset(df.growthrates, df$country %in% df.test.april$country & date=='2020-04-01')

#test.result<-summary(df.augresult.test$case_proportion)


df.notest.april<-subset(df.growthrates, testing==0 & date=='2020-04-01')

df.augresult.notest<-subset(df.growthrates, df$country %in% df.notest.april$country & date=='2020-04-01')

#nomass.result<-summary(df.augresult.notest$case_proportion)

boxplot(df.augresult.test$growth2, df.augresult.notest$growth2,
        names=c('Testing Policy in April', 'No Testing Policy in April'),
        ylim=c(0, 10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st testing policy')
```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD LOCKDOWN POLICY IN APRIL VERSUS ###
### NO LOCKDOWN POLICY IN APRIL ###

df.ld.april<-subset(df.growthrates, domestic==1 & date=='2020-04-01')

df.augresult.ld<-subset(df.growthrates, df$country %in% df.ld.april$country & date=='2020-04-01')

#ld.result<-summary(df.augresult.ld$case_proportion)


df.nold.april<-subset(df.growthrates, domestic==0 & date=='2020-04-01')

df.augresult.nold<-subset(df.growthrates, df$country %in% df.nold.april$country & date=='2020-04-01')

#nold.result<-summary(df.augresult.nold$case_proportion)

boxplot(df.augresult.ld$growth2, df.augresult.nold$growth2,
        names=c('Lockdown Policy in April', 'No Lockdown Policy in April'),
        ylim=c(0,10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st lockdown policy')

```

```{r}
### GENERATE BOXPLOT FOR COUNTRIES WHICH HAD RESTURANT POLICY IN APRIL VERSUS ###
### NO LOCKDOWN POLICY IN APRIL ###

df.ld.april<-subset(df.growthrates, rest==1 & date=='2020-04-01')

df.augresult.ld<-subset(df.growthrates, df$country %in% df.ld.april$country & date=='2020-04-01')

ld.result<-summary(df.augresult.ld$case_proportion)


df.nold.april<-subset(df.growthrates, rest==0 & date=='2020-04-01')

df.augresult.nold<-subset(df.growthrates, df$country %in% df.nold.april$country & date=='2020-04-01')

nold.result<-summary(df.augresult.nold$case_proportion)

boxplot(df.augresult.ld$growth2, df.augresult.nold$growth2,
        names=c('Restaurant Closures in April', 'No Rest. Closures in April'),
        ylim=c(0,10),
        main='Cumulative case growth rate from Apr to Aug based on Apr 1st lockdown policy')

```



## Inferential Analysis
Our primary question of interest is whether certain policies enacted at the national and sub-national level may be associated with different outcomes in terms of the cumulative case proportion and growth of cumulative cases a country experiences over a five month period. The policies we have examined include mask wearing obligations, testing implementation, lockdown enforcement, and restaurant closures. These policies were measured according to their implementation on April 1st of 2020. If the policy had been implemented at the national or local level by that date, then the variable takes a variable of one. If the policy had not been implemented, it takes a value of zero. 

It is important to emphasize that the goal of this model is not to assess causality, but to determine what factors are associated with certain outcomes.

A secondary question of interest then entails which of these different policies, if any, are associated with country wide case proportions measured five months later on August 31, as well as the average growth rate of cases during that same five month interval. 

For the purposes of this study, case proportion is defined as $X_i/N_i$, where $X_i$ represents the cumulative cases recorded for the i-th country on August 31 of 2020, and $N_i$ corresponds to that country's population in 2019. Cumulative case growth rate is defined as the difference in natural logarithms $ln(X_{i,{t+1}})-ln(X_{i,t})$ where $X_{i,{t+1}}$ corresponds to the number of cumulative cases recorded within the i-th country on August 31st, and $X_{i,t}$ corresponds to the number of cumulative cases recorded in the i-th country on April 1st.

We first employ a linear regression model of the form:

$$Y_{i,t+1}=\beta_0+\beta_1masks_{i,t}+\beta_2testing_{i,t}+\beta_3lockdown_{i,t}+\beta_4restaurants \space closed_{i,t} $$


Where each variable is a dummy which takes a value of 1 if the i-th country implemented the respective policy in time period $t$. The outcome is cumulative cases in the i-th country as recorded in time period $t+1$.


The second linear regression model takes a similar form: 

$$Y_{i,t+1}=\beta_0+\beta_1masks_{i,t}+\beta_2testing_{i,t}+\beta_3lockdown_{i,t}+\beta_4restaurants \space closed_{i,t} $$

except here the outcome is defined as the log difference in cumulative cases between April 1st and August 31st.

Both models, being linear regression models, rely on several key assumptions. 

      1) the expected value of the response variable is influenced additively (if no interaction terms are              present) and linearly by the factors

      2) Each sample is independent and selected from an underlying population which is normally distributed

      3) Homogeneity of variance between groups (Homoskedasticity)

      4) The error terms are normally distributed with constant mean and variance
```{r}
## Created a dataframe with just the country, growth rate in August, whether mask testing, lockdown in April

# Can be used for anova model
#masking_policy_april = subset(df, date =='2020-04-01')
#august_results = subset(df, date == "2020-08-31")
#df1 = data.frame( country =masking_policy_april$country, case_growth = august_results$case.growth, masks =masking_policy_april$masks,
                 #lockdown =masking_policy_april$domestic,
                 #testing =masking_policy_april$testing )
```

```{r}


### Adam model ###



model_case.proportion<-glm(data=df, formula=case_proportion[which(date=='2020-08-31')]~
            masks[which(date=='2020-04-01')]+testing[which(date=='2020-04-01')]+
            domestic[which(date=='2020-04-01')]+rest[which(date=='2020-04-01')])


model_growth.rate<-lm(data=df.growthrates, formula=growth2[which(date=='2020-04-01')]~
            masks[which(date=='2020-04-01')]+testing[which(date=='2020-04-01')]+
            domestic[which(date=='2020-04-01')]+rest[which(date=='2020-04-01')])

model_growth.rate.av<-aov(model_growth.rate)

summary(model_growth.rate.av)
summary(model_case.proportion)
summary(model_growth.rate)

```


We find that the model which measures case proportion in August as an outcome finds restaurant closures to be significant at the $\alpha=0.5$ level. This first model also finds testing to have a statistically significant association with case proportions five months later, at the $\alpha=0.10$ level.

For the second model, we find that testing has a statistically significant association with the difference in log of cumulative cases between August 31 and April 1st, at the $\alpha=0.01$ significance level.

In the final project, we can use Tukey's Honestly Significantly Difference test to construct pairwise confidence intervals for the different groups.

## Sensitivity Analysis

```{r}
plot(model_case.proportion,which =1)
```

The residuals versus fitted plot shows the spread widening as the predicted values increases. This indicates that that the errors do not have equal variance. If the errors were normally distributed the errors would have be spread evenly and randomly around the 0 line. Observations 20,253 and 165 seems to have a high variance.
```{r}
plot(model_case.proportion,which =2)
```

The normal Q-Q plot shows that the errors have heavy tail on the right. Again observations 20,153,165 are contributing to the problem. The errors are not normally distributed.

```{r}
plot(model_case.proportion,which =3)
```

The scale location plot is also used to check the equal variance assumption. Again it is visible that the spread of variance increases as the predicted value increases. Also as expected observations 20, 153 and 165 are still outliers.
```{r}
plot(model_case.proportion,which =4)
```


The residuals versus Leverage plot shows that the spread of standardized residuals is decreasing indicating that the variances are unequal. There are no observations outside the red lines so that there are no highly influentail data points.

Using an alternative model that looked at case growth rate in August as the response variable the we get the following sensitivity results for the model.
```{r}
# New case growth rate model
plot(model_growth.rate,which =1)
```

The residuals versus fitted plot for case growth rate is evenly and randomly spread spread over the line y=0. The spread does get wider slightly around predicted value 4.0. But the errors do have equal variance. Observations 86 and 139 are high outliers. While 24 is low outlier.

```{r}
plot(model_growth.rate,which =2)
```
    
From the normal Q-Q plot the residuals have lighter tail on both ends. But it looks symmetrically lighter. And they do follow the line mostly. So the errors are normally distributed. The outliers 86,139 and 24 are pulling the distribution away from normal.

```{r}
plot(model_growth.rate,which =3)
```

The scale location plot shows that the red line is almost horizontal. The spread does get larger towards higher fitted values but it centered. We can back up the claim that the errors have equal variance. Observations 139 and 24 are noted as outliers.

```{r}
plot(model_growth.rate,which =4)
```


Cook's distance measures the influence certain observations have on distributions. The higher Cook's distance is the more influential the observation is. Observations 16,86,99 are noted have large Cook's distance.

```{r}
  tmp =df.growthrates$growth2[which(df.growthrates$date=='2020-04-01')]
mean(tmp)
sd(tmp)
tmp[86]
```
So observation 86 had a case growth rate 2 standard deviations above the mean.

## Discussion & Conclusion ##

In this report we performed an analysis of two data sets obtained from the World Health Organization and the  University of Oxford’s COVID-19 Government response tracker. Our question of interest is surrounded around the the new case proportion growth rate, specifically we want to study the differences in the new case growth rates between April and August in the “Americas” region that had a mask mandate, testing, and/or lockdown policy implemented by April 1st, 2020 versus those that didn’t. The key question is that if there is a statistically significant difference between the new case growth rates between the two groups and if we do find a significant difference in new case proportion growth rates, we want to know if those with lockdown, mask, and testing policies have lowered case proportions after implementing such measures. 


To answer this question we first presented appropriate plots in the report. Among these plots were box plots that showed that when testing, masks, and/or lockdown procedures and policies were implemented the cumulative case growth from April to August were much lower than when these policies were not put into place by April 1st.  To test for statistical significance we constructed a multiple variable general linear model to fit our data set. We set the new case proportion growth rate as the response variable, and we set whether masks mandates, testing, lockdown policies and restaurant closures were implemented in the “America’s” region as the independent variables. This allowed us to statistically assess whether or not the difference in new case proportion growth rates were significant. We found that testing policy and mask policy were statistically significant at the 10% level, since the p-values < 0.1. Comparatively the restaurant closures were found to be statistically significant at the general 5% level as the p-value < 0.05. Additionally, we see that the coefficient estimate of the “rest” variable came out to be a negative value. This suggests that case growth and restaurant closures are negatively correlated, which means that case growth decreased as restaurant closures increased. To check that our assumptions for the generalized linear model were met, we performed sensitivity analysis on our data. We found that residuals from the model do not have equal variance as the residuals vs fitted plot shows that residuals seem to fan out as the fitted values increase. If the residuals were to truly have equal variance, the errors would be spread out  evenly around the zero line in our plot. It was also observed that the errors in the model are not normally distributed (confirmed using a normal Q-Q plot, which showed a heavy right tail). Another method to check the equal variance assumption was through the scale location plot and we found once again that the standardized pearson residuals drastically fan out and increase as the predicted values increase. 
We also included a residuals vs leverage plot in our report which also shows that the variances of the residuals are not equal as the residuals spread out as the predictive values increase.

 Because our assumptions of equal variances failed for the first model we propose an alternative model for this analysis that features the following factors in relation to the cumulative new cases growth rate: existence of mask mandate, implementation of lockdown, and closure of restaurants and public dining spaces. For this particular model, the residuals vs fitted values plot revealed that the errors did have equal variance, since the spread of the plotted residuals remained evenly spread over line y = 0 save for a handful of few outliers. Additionally, the normal Q-Q plot had a lighter tail than the previous model and did appear to be linear, indicating that the errors were normally distributed.

For future research and policy making, one can create a model where vaccination and immunity data is also taken into consideration and applied into the model. This model would produce more current up to date results as vaccinations have just begun to ramp up in the “Americas” regions, which means that one can hypothesize that new case proportions would go down.


